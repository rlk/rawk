# Assemble the 16 tiles of the Mission Experiment Gridded Topography to a
# single 23040 x 46080 image.

MEGT= \
	paste 17152 34560 input megt44s270hb.img 0 5632 11520 1 S \
	paste 17152 23040 input megt44s180hb.img 0 5632 11520 1 S \
	paste 17152 11520 input megt44s090hb.img 0 5632 11520 1 S \
	paste 17152     0 input megt44s000hb.img 0 5632 11520 1 S \
	paste 11520 34560 input megt00n270hb.img 0 5632 11520 1 S \
	paste 11520 23040 input megt00n180hb.img 0 5632 11520 1 S \
	paste 11520 11520 input megt00n090hb.img 0 5632 11520 1 S \
	paste 11520     0 input megt00n000hb.img 0 5632 11520 1 S \
	paste  5888 34560 input megt44n270hb.img 0 5632 11520 1 S \
	paste  5888 23040 input megt44n180hb.img 0 5632 11520 1 S \
	paste  5888 11520 input megt44n090hb.img 0 5632 11520 1 S \
	paste  5888     0 input megt44n000hb.img 0 5632 11520 1 S \
	paste   256 34560 input megt88n270hb.img 0 5632 11520 1 S \
	paste   256 23040 input megt88n180hb.img 0 5632 11520 1 S \
	paste   256 11520 input megt88n090hb.img 0 5632 11520 1 S \
	paste   256     0 input megt88n000hb.img 0 5632 11520 1 S \
	                  solid 23040 46080 0

# The subtleties of a 16-bit height map are difficult to detect by eye.
# Detect the edges of the height map to produce a useful reference.

OUTLINE= gain 10.0 absolute gradient 2 $(MEGT)

# MOLA interpolation was clearly performed on 2048-pixel chunks. This resulted
# in a discontinuity in the derivative with respect to latitude in the in-fill
# areas every 2048 lines. This becomes very apparent in shaded relief.
#
# Mark the affected scan lines above and below each discontinuity. This is the
# first step in isolating the artifact and filtering it out.

BADLINES= \
	paste  1279 0 solid     2 46080 1 \
	paste  3327 0 solid     2 46080 1 \
	paste  5375 0 solid     2 46080 1 \
	paste  7423 0 solid     2 46080 1 \
	paste  9471 0 solid     2 46080 1 \
	paste 11519 0 solid     2 46080 1 \
	paste 13567 0 solid     2 46080 1 \
	paste 15615 0 solid     2 46080 1 \
	paste 17663 0 solid     2 46080 1 \
	paste 19711 0 solid     2 46080 1 \
	paste 21759 0 solid     2 46080 1 \
				  solid 22528 46080 0

# As these discontinuities are found in the derivative with respect to latitude,
# they can be detected by a vertical Sobel filter, thresholded to trigger only
# on significant change. Of course a vertical Sobel filter will highlight every
# north-south change in elevation, but since we know the discontinuities lie
# along specific sets of scan lines, the product of the filter with the scan
# line mask highlights precisely what we want.
#
# Multiply the scan line on the left as it's mostly zeros and will short-circuit
# the more expensive evaluation of the Sobel filter.

BADPIXELS= multiply \
				$(BADLINES) \
				threshold 0.015 absolute sobely 2 $(MEGT)

# If the bad pixels were simply replaced with repared pixels then new
# discontinuities would emerge. We must instead blend toward the repair.
#
# Generate a blend mask by "feathering" the bad pixels. Gauss blur with a
# standard deviation of 1.0. We'll need to dilate by three times that radius
# to ensure that the lit pixels of the input remain 100% lit after the blur.

BADMASK= gaussian 1 2 dilate 3 2 $(BADPIXELS)

# Despite the discontinuity in the input, none of the pixels are bad, as such.
# They're simply not connect relative to one another. The only way to fix them
# then is to move them closer to one another using a wide blur.

BLURRED= gaussianv 4 2 $(MEGT)

# Blend the original input with its blurred self using our carefully-crafted
# mask.

REPAIRED= blend append $(BLURRED) $(BADMASK) $(MEGT)

NORTH= offset 0 23040 2 gain 0.0000305185 input megt_n_128_1.raw 0 23040 46080 1 f
SOUTH= offset 0 23040 2 gain 0.0000305185 input megt_s_128_1.raw 0 23040 46080 1 f

NORTH_SCALE= crop  0 0 23040 46080 linear 23050 46080 2 $(NORTH)
SOUTH_SCALE= crop 25 0 23040 46080 linear 23065 46080 2 $(SOUTH)

test :
	rawk sum $(OUTLINE) $(BADLINES)

preview :
	rawk gain 10.0 absolute gradient 2 $(REPAIRED)

merge :
	rawk \
		append $(MEGT) \
			offset 0 23040 2 input megt_s_128_1.raw 0 23040 46080 1 f

align :
	rawk \
		absolute \
		gain 10.0 \
		gradient 2 \
		append $(NORTH_SCALE) append $(MEGT) $(SOUTH_SCALE)

diff :
	rawk \
		absolute \
		gain 100.0 \
		difference $(MEGT) sum $(NORTH_SCALE) $(SOUTH_SCALE)

poles : megt_s_128_1.raw megt_n_128_1.raw

megt_s_128_1.raw : megt_s_128_1.tif
	rawtif $< $@

megt_s_128_1.tif : megt_s_128_1.lbl
	scmtiff -T -prectify -n23040 $<

megt_n_128_1.raw : megt_n_128_1.tif
	rawtif $< $@

megt_n_128_1.tif : megt_n_128_1.lbl
	scmtiff -T -prectify -n23040 $<
